name: CI/CD MonitorBot

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci-cd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install --no-cache-dir -r requirements.txt

      - name: Lint code with flake8
        run: |
          pip install flake8
          flake8 .

      - name: Run tests
        run: |
          pip install pytest
          pytest || echo "Tests failed but continuing workflow"

      - name: Build Docker image
        run: docker build -t monitorbot-image .

      - name: Create docker-compose.override.yml
        run: |
          echo "version: '3.9'" > docker-compose.override.yml
          echo "services:" >> docker-compose.override.yml
          echo "  alert-monitor:" >> docker-compose.override.yml
          echo "    image: monitorbot-image" >> docker-compose.override.yml
          echo "    environment:" >> docker-compose.override.yml
          echo "      - BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> docker-compose.override.yml
          echo "      - CHAT_ID=${{ secrets.CHAT_ID }}" >> docker-compose.override.yml
          echo "    volumes:" >> docker-compose.override.yml
          echo "      - ./logs:/app/logs" >> docker-compose.override.yml
          echo "    restart: always" >> docker-compose.override.yml

      - name: Run Docker Compose
        run: docker-compose -f docker-compose.override.yml up -d

      - name: Show running containers
        run: docker ps
